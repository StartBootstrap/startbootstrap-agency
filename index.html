<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Visualizing Flickr</title>

    <!-- Bootstrap Core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="css/agency.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
    <link href='https://fonts.googleapis.com/css?family=Kaushan+Script' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Roboto+Slab:400,100,300,700' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- D3 Styles -->
    <style>
        path {
          fill: none;
          stroke-linejoin: round;
          stroke-linecap: round;
        }

        /* Underlying Map */
        .major_road { stroke: #776; }
        .minor_road { stroke: #ccb; }
        .highway { stroke: #776; stroke-width: 1.5px; }
        .rail { stroke: #776; }
        .ferry { stroke-dasharray: 5 5; opacity: 0.1; }

        .legendOrdinal { font-size: 12px; }
        .maptips {
          position: absolute;
          z-index: 1060;
          display: inline;
          width: 250px;
          padding: 1px;
          font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
          font-size: 14px;
          font-style: normal;
          font-weight: normal;
          line-height: 1.42857143;
          text-align: left;
          text-align: start;
          text-decoration: none;
          text-shadow: none;
          text-transform: none;
          letter-spacing: normal;
          word-break: normal;
          word-spacing: normal;
          word-wrap: normal;
          white-space: normal;
          background-color: #fff;
          -webkit-background-clip: padding-box;
                  background-clip: padding-box;
          border: 1px solid #ccc;
          border: 1px solid rgba(0, 0, 0, .2);
          border-radius: 6px;
          -webkit-box-shadow: 0 5px 10px rgba(0, 0, 0, .2);
                  box-shadow: 0 5px 10px rgba(0, 0, 0, .2);
          line-break: auto;
        }

    </style>

</head>

<body id="page-top" class="index">

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand page-scroll" href="#page-top">Visualizing Flickr</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    <li class="hidden">
                        <a href="#page-top"></a>
                    </li>
                    <li>
                        <a class="page-scroll" href="#data">Data</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="#cities">Cities</a>
                    </li>                                        
                    <li>
                        <a class="page-scroll" href="#team">Team</a>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container-fluid -->
    </nav>

    <!-- Header -->
    <header>
        <div class="container">
            <div class="intro-text">
                <div class="intro-lead-in">Welcome To Our Studio!</div>
                <div class="intro-heading">It's Nice To Meet You</div>
                <a href="#data" class="page-scroll btn btn-xl">Explore</a>
            </div>
        </div>
    </header>

    <!-- Data Section -->
    <section id="data">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <h2 class="section-heading">Data</h2>
                    <h3 class="section-subheading text-muted">Lorem ipsum dolor sit amet consectetur.</h3>
                </div>
            </div>
            <div class="row text-center">
                <div class="col-md-4">
                    <span class="fa-stack fa-4x">
                        <i class="fa fa-circle fa-stack-2x text-primary"></i>
                        <i class="fa fa-shopping-cart fa-stack-1x fa-inverse"></i>
                    </span>
                    <h4 class="service-heading">E-Commerce</h4>
                    <p class="text-muted">Lorem ipsum dolor sit amet, consectetur adipisicing elit. Minima maxime quam architecto quo inventore harum ex magni, dicta impedit.</p>
                </div>
                <div class="col-md-4">
                    <span class="fa-stack fa-4x">
                        <i class="fa fa-circle fa-stack-2x text-primary"></i>
                        <i class="fa fa-laptop fa-stack-1x fa-inverse"></i>
                    </span>
                    <h4 class="service-heading">Responsive Design</h4>
                    <p class="text-muted">Lorem ipsum dolor sit amet, consectetur adipisicing elit. Minima maxime quam architecto quo inventore harum ex magni, dicta impedit.</p>
                </div>
                <div class="col-md-4">
                    <span class="fa-stack fa-4x">
                        <i class="fa fa-circle fa-stack-2x text-primary"></i>
                        <i class="fa fa-lock fa-stack-1x fa-inverse"></i>
                    </span>
                    <h4 class="service-heading">Web Security</h4>
                    <p class="text-muted">Lorem ipsum dolor sit amet, consectetur adipisicing elit. Minima maxime quam architecto quo inventore harum ex magni, dicta impedit.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Cities Maps Section -->
    <section id="cities" class="bg-light-gray">
        <div class="container">
            <div class="row san-francisco">
                <div class="col-lg-12 text-center">
                    <h2 class="section-heading">San Francisco</h2>
                    <h3 class="section-subheading text-muted">Lorem ipsum dolor sit amet consectetur.</h3>
                </div>                
                <div class="btn-group" role="group" id="sffilter"></div> 	            		            
            	<div class="cities-maps" id="sfviz"></div>
                <div class="map-legend"></div>
            	
            </div>
            <div class="row new-york">
                <div class="col-lg-12 text-center">
                    <h2 class="section-heading">New York</h2>
                    <h3 class="section-subheading text-muted">Lorem ipsum dolor sit amet consectetur.</h3>
                </div>                
                <div class="btn-group" role="group" id="nyfilter"></div>                
                <div class="cities-maps" id="nyviz"></div>
                <div class="map-legend"></div>                
            </div>
        </div>
    </section>

    <!-- Team Section -->
    <section id="team" class="bg-light-gray">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <h2 class="section-heading">Our Amazing Team</h2>
                    <h3 class="section-subheading text-muted">Lorem ipsum dolor sit amet consectetur.</h3>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-4">
                    <div class="team-member">
                        <img src="img/team/1.jpg" class="img-responsive img-circle" alt="">
                        <h4>Kay Garland</h4>
                        <p class="text-muted">Lead Designer</p>
                        <ul class="list-inline social-buttons">
                            <li><a href="#"><i class="fa fa-twitter"></i></a>
                            </li>
                            <li><a href="#"><i class="fa fa-facebook"></i></a>
                            </li>
                            <li><a href="#"><i class="fa fa-linkedin"></i></a>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="col-sm-4">
                    <div class="team-member">
                        <img src="img/team/2.jpg" class="img-responsive img-circle" alt="">
                        <h4>Larry Parker</h4>
                        <p class="text-muted">Lead Marketer</p>
                        <ul class="list-inline social-buttons">
                            <li><a href="#"><i class="fa fa-twitter"></i></a>
                            </li>
                            <li><a href="#"><i class="fa fa-facebook"></i></a>
                            </li>
                            <li><a href="#"><i class="fa fa-linkedin"></i></a>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="col-sm-4">
                    <div class="team-member">
                        <img src="img/team/3.jpg" class="img-responsive img-circle" alt="">
                        <h4>Diana Pertersen</h4>
                        <p class="text-muted">Lead Developer</p>
                        <ul class="list-inline social-buttons">
                            <li><a href="#"><i class="fa fa-twitter"></i></a>
                            </li>
                            <li><a href="#"><i class="fa fa-facebook"></i></a>
                            </li>
                            <li><a href="#"><i class="fa fa-linkedin"></i></a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 text-center">
                    <p class="large text-muted">Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aut eaque, laboriosam veritatis, quos non quis ad perspiciatis, totam corporis ea, alias ut unde.</p>
                </div>
            </div>
        </div>
    </section>

    <footer>
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <span class="copyright">Copyright &copy; Your Website 2014</span>
                </div>
                <div class="col-md-4">
                    <ul class="list-inline social-buttons">
                        <li><a href="#"><i class="fa fa-twitter"></i></a>
                        </li>
                        <li><a href="#"><i class="fa fa-facebook"></i></a>
                        </li>
                        <li><a href="#"><i class="fa fa-linkedin"></i></a>
                        </li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <ul class="list-inline quicklinks">
                        <li><a href="#">Privacy Policy</a>
                        </li>
                        <li><a href="#">Terms of Use</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="js/bootstrap.min.js"></script>

    <!-- Plugin JavaScript -->
    <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.3/jquery.easing.min.js"></script>
    <script src="js/classie.js"></script>
    <script src="js/cbpAnimatedHeader.js"></script>

    <!-- Contact Form JavaScript -->
    <script src="js/jqBootstrapValidation.js"></script>
    <script src="js/contact_me.js"></script>

    <!-- Custom Theme JavaScript -->
    <script src="js/agency.js"></script>

    <!-- D3 Plugins -->
    <script src="//d3js.org/d3.v3.min.js"></script>
    <script src="//d3js.org/topojson.v1.min.js"></script>
    <script src="//d3js.org/queue.v1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/1.5.0/d3-legend.min.js"></script>
    <script src="js/d3.hexbin.min.js"></script>
    <script src="js/d3.geo.tile.min.js"></script>

    <!-- D3 Script -->
    <script>
        var width = Math.max(960, 0.9*window.innerWidth),
            height = Math.max(700, 0.65*window.innerHeight);

        console.log(window.innerWidth);

        function getRandomIntInclusive(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        };

        var tiler = d3.geo.tile()
            .size([width, height]);        

        var hexbin = d3.hexbin()
            .size([width, height])
            .radius(20);

        var coordinates = [[-122.421356, 37.785839], [-73.993952, 40.734331]];

        // Select 5 camera makers
        var camera_makers = ["CANON", "NIKON", "APPLE", "SONY", "PANASONIC"];
        var color_brands = d3.scale.ordinal()
            .domain(camera_makers)
            .range(["#1f78b4", "#33a02c", "#ff7f00", "#6a3d9a", "#e31a1c"]);

        var color_scale = d3.scale.pow()
            .exponent(0.333)
            .interpolate(d3.interpolateHsl);


        var projection = d3.geo.mercator()
	        .scale((1 << 21) / 2 / Math.PI)
	        .translate([width / 2, height / 2])
	        .center(coordinates[0]);

        var path = d3.geo.path()
            .projection(projection);

        var svg = d3.select("#sfviz").append("svg")
            .attr("width", width)
            .attr("height", height);

        // Underlying Map
        svg.selectAll("g")
            .data(tiler
                .scale(projection.scale() * 2 * Math.PI)
                .translate(projection([0, 0])))
            .enter().append("g")
            .each(function(d) {
                var g = d3.select(this);                
                d3.json("http://vector.mapzen.com/osm/roads/" + d[2] + "/" + d[0] + "/" + d[1] + ".topojson?api_key=vector-tiles-6A2EEiQ", function(error, json) {
                    var geojson_data = topojson.feature(json, json.objects.vectile);
                    g.selectAll("path")
                        .data(geojson_data.features.sort(function(a, b) { return a.properties.sort_key - b.properties.sort_key; }))
                        .enter().append("path")
                        .attr("class", function(d) { return d.properties.kind; })
                        .attr("d", path);
                });
            });

        // Legends
        var map_legend = d3.selectAll(".map-legend")
            .append("svg")
            .attr("width", width/2)
            .attr("height", 50);

        map_legend.append("g")
            .attr("class", "legendOrdinal")
            .attr("transform", "translate(20,20)");

        var legendOrdinal = d3.legend.color()
            .shape("path", hexbin.hexagon(12))
            .shapePadding(50)
            .orient("horizontal")
            .scale(color_brands);

        map_legend.select(".legendOrdinal")
            .call(legendOrdinal);

        // Load data
        queue()
            .defer(d3.csv, "data/sf.csv")
            .await(ready);

        function ready(error, flickr) {
            if (error) throw error;            

           	// Call map function
           	map_viz(flickr, {"low":2005, "high":2014});
           	function map_viz(flickr, filter) {
           		// Project long/lat into pixel coordinates
	            flickr.forEach(function(d) {            	
	                var p = projection([d.longitude, d.latitude]);
	                d[0] = p[0];
	                d[1] = p[1];
	                d.year = parseInt(d.year);
	            });

	            // Filter	            
	            flickr_filtered = flickr.filter(function(d) { return d.year>=filter.low & d.year<=filter.high; });	            

	            // Create hexbins
	            var hex_flickr = hexbin(flickr_filtered);
	            var global_max = 0;

	            // Get camera counts of each hexbin
	            hex_flickr.forEach(function(hex) {
	                hex.camera_counts = {CANON:0, NIKON:0, APPLE:0, SONY:0, PANASONIC:0};
	                hex.max_camera = "";
	                hex.max_photos = 0;
	                hex.forEach(function(d) {
	                    if (d.camera in hex.camera_counts) {
	                        hex.camera_counts[d.camera] += 1;   
	                    };          
	                });
	                for (var key in hex.camera_counts){
	                    if (hex.camera_counts[key] > hex.max_photos) {
	                        hex.max_photos = hex.camera_counts[key];
	                        hex.max_camera = key;

	                        if (hex.max_photos > global_max) {
	                        global_max = hex.max_photos;
	                        };  
	                    };
	                    
	                };
	            });

	            // Set color scale
	            color_scale.domain([0, global_max]);

	            // Draw hexagons	            
	            svg.selectAll(".hexagons")	            	
	            	.remove();

	            svg.append("g")
	                .attr("class", "hexagons")
	                .selectAll("path")
	                .data(hex_flickr)
	                .enter().append("path")
	                .attr("d", hexbin.hexagon())
	                .attr("transform", function(d) {return "translate(" + d.x + "," + d.y + ")";})
	                .style("fill", function(d) {
	                    color_scale.range(["white", color_brands(d.max_camera)]);
	                    return color_scale(d.max_photos);
	                })
	                .style("opacity", 0.8);

	            // Tooltips
	            svg.select(".hexagons").selectAll("path")
	                .on("mouseover", create_tooltip)
	                .on("mouseout", delete_tooltip);

	            function create_tooltip(d) {
	                var url_index = getRandomIntInclusive(0, d.length-1);

	                d3.select(this).style("stroke", "#FDB515")
	                	.style("stroke-width", "3px");

	                var hover_tip = d3.select("body")
	                                    .append("div")
	                                    .attr("class", "maptips")
	                                    .attr("display", "inline")
	                                    .style("left", (d3.event.pageX + 10) + "px")
	                                    .style("top", (d3.event.pageY) + "px");
	                                    
	                hover_tip.append("img")
	                    .attr("src", d[url_index].url)
	                    .attr("class", "img-responsive");

	                hover_tip.append("p")
	                    .text("Photo by: " + d[url_index].user);
                    
                    var camera_ref = camera_makers.map( function(k) { 
                        var rObj = {};
                        rObj["camera"] = k
                        rObj["count"] = d.camera_counts[k];
                        return rObj;
                        });                    

                    var table_row = hover_tip.append("table")
                        .attr("class", "table")
                        .selectAll("tr")
                        .data(camera_ref)
                        .enter()
                        .append("tr");

                    table_row.append("td")                        
                        .html(function(e){ return e.camera; });

                    table_row.append("td")                        
                        .html(function(e){ return Math.round(e.count/d.length*100) + "% " + "(" + e.count + ")"; });

	            };

	            function delete_tooltip(d) {
	            	d3.select(this)
	            		.transition()
	            		.duration(200)
	                	.style("stroke-width", "0px");
	                d3.select(".maptips").remove();
	            };
           	};

           	// Filtering mechanism
            d3.select("#sffilter")
            	.append("button")
            	.attr("class", "btn btn-default").attr("type", "button")
           	    .on("click", function(){ map_viz(flickr, {"low":1000, "high":2007}); })
           	    .html("&mdash;2007");

           	d3.select("#sffilter")
            	.append("button")
            	.attr("class", "btn btn-default").attr("type", "button")
            	.on("click", function(){ map_viz(flickr, {"low":2008, "high":2011}); })
           	    .html("2008&ndash;2011");

           	d3.select("#sffilter")
            	.append("button")
            	.attr("class", "btn btn-default").attr("type", "button")
            	.on("click", function(){ map_viz(flickr, {"low":2012, "high":3000}); })
           	    .html("2012&mdash;");

           	d3.select("#sffilter")
            	.append("button")
            	.attr("class", "btn btn-default").attr("type", "button")
            	.on("click", function(){ map_viz(flickr, {"low":1000, "high":3000}); })
           	    .html("ALL");
        };

    </script>


</body>

</html>
